name: Linux Build&Deploy

on:
  push:
      
jobs:
  build-linux:
    runs-on: ubuntu-latest
    env:
      QT_VERSION:       "6.4.3"
      BT_VERSION:       "gcc_64"
      QT_ROOTDIR:       ""
      BUILD_TYPE:       MinSizeRel
      BIN_OUTPUT_DIR:   ${{ github.workspace }}/out
      CMAKE_CONF_DIR:   ${{ github.workspace }}/build
      STAGING_DIR:      ${{ github.workspace }}/artifacts
    
    steps:
    
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        host: linux
        version: ${{ env.QT_VERSION }}
        arch: ${{ env.BT_VERSION }}
        dir: "${{ github.workspace }}/qt"
        cache: true
        
    - name: Set Qt path
      run: ${{ env.QT_ROOTDIR }}="${{ github.workspace }}/qt/Qt/${{ env.QT_VERSION }}/${{ env.BT_VERSION }}/bin"

    - name: Configure the CMake project
      env:
        CMAKE_PREFIX_PATH: ${{ env.QT_ROOTDIR }}
      run: cmake -DCMAKE_BUILD_TYPE=$BUILD_TYPE -G "Unix Makefiles" -B ${{ env.CMAKE_CONF_DIR }} -DCUSTOM_BIN_OUTPUT_ROOT=${{ env.BIN_OUTPUT_DIR }}

    - name: Build the project
      run: cmake --build ${{ env.CMAKE_CONF_DIR }}
      
    - name: Deploy the program
      run: |
        mkdir ${{ env.STAGING_DIR }}
        cd ${{ env.STAGING_DIR }}
        cp ${{ env.CMAKE_CONF_DIR }}/MGEWin64 ${{ env.STAGING_DIR }}/
        # lindeployqt --compiler-runtime --qmldir ${{ github.workspace }} MGEWin64
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: MGE Linux
        path: ${{ github.workspace }}/artifacts
