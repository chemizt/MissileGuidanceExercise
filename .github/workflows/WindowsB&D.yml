name: Windows Build&Deploy

on:
  push:
      
jobs:
  build-windows:
    runs-on: windows-latest
    env:
      QT_VERSION:     "6.4.3"
      QT_ROOTDIR:     ""
      BT_VERSION:     "win64_msvc2019_64"
      BUILD_TYPE:     MinSizeRel
      BIN_OUTPUT_DIR: ${{ github.workspace }}/out
      CMAKE_CONF_DIR: ${{ github.workspace }}/build
      STAGING_DIR:    ${{ github.workspace }}/artifacts
    
    steps:
    
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        host: windows
        version: ${{ env.QT_VERSION }}
        arch: ${{ env.BT_VERSION }}
        dir: "${{ github.workspace }}/qt"
        cache: true
        
    - name: Set Qt path
      run: ${{ env.QT_ROOTDIR }}="${{ github.workspace }}/qt/Qt/${{ env.QT_VERSION }}/${{ env.BT_VERSION }}/bin"

    - name: Configure the CMake project
      env:
        CMAKE_PREFIX_PATH: ${{ env.QT_ROOTDIR }}
      run: cmake -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -G "Visual Studio 17 2022" -B ${{ env.CMAKE_CONF_DIR }} -DCUSTOM_BIN_OUTPUT_ROOT=${{ env.BIN_OUTPUT_DIR }}

    - name: Build the project
      run: cmake --build ${{ env.CMAKE_CONF_DIR }}
      
    - name: Deploy the program
      run: |
        mkdir ${{ env.STAGING_DIR }}
        cd ${{ env.STAGING_DIR }}
        cp ${{ env.CMAKE_CONF_DIR }}/MGEWin64.exe ${{ env.STAGING_DIR }}/
        windeployqt --compiler-runtime --qmldir ${{github.workspace}} MGEWin64.exe
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: MGE Windows
        path: ${{ github.workspace }}/artifacts
